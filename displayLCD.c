#include <stdint.h>
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <getopt.h>
#include <fcntl.h>
#include <time.h>
#include <sys/ioctl.h>
#include <linux/ioctl.h>
#include <linux/input.h>
#include <sys/stat.h>
#include <linux/types.h>
#include <linux/spi/spidev.h>
#include <linux/gpio.h>
#include "gpio_dev.h"
#include "spi_8MM_driver.h"



#define ROW_BYTE_NUM (1272 * 3)
#define ARRAY_SIZE(a) (sizeof(a) / sizeof((a)[0]))

#define GPIO_DCX 9
#define GPIO_RESX 87
#define GPIO_CS0 8

void init_gpio(void)
{
	gpio_Export(GPIO_DCX);
	gpio_Export(GPIO_RESX);
	gpio_Export(GPIO_CS0);

	gpio_SetDirection(GPIO_DCX, GPIO_DIRECTION_OUT);
	gpio_SetDirection(GPIO_RESX, GPIO_DIRECTION_OUT);
	gpio_SetDirection(GPIO_CS0, GPIO_DIRECTION_OUT);
}

void unexport_gpio(void)
{
	gpio_Unexport(GPIO_DCX);
	gpio_Unexport(GPIO_RESX);
	gpio_Unexport(GPIO_CS0);
}

void LCD_WrCmd(unsigned char cmd)
{
	gpio_SetValue(GPIO_DCX, GPIO_VALUE_LOW);
	gpio_SetValue(GPIO_CS0, GPIO_VALUE_LOW);

	transfer_data(cmd);

	gpio_SetValue(GPIO_DCX, GPIO_VALUE_HIGH);
	gpio_SetValue(GPIO_CS0, GPIO_VALUE_HIGH);
}

void LCD_WrDat(unsigned char dat)
{
	gpio_SetValue(GPIO_CS0, GPIO_VALUE_LOW);

	transfer_data(dat);

	gpio_SetValue(GPIO_CS0, GPIO_VALUE_HIGH);
}

void LCD_SetCmd1(unsigned char cmd, unsigned char dat)
{
	LCD_WrCmd(cmd);
	LCD_WrDat(dat);
}

void LCD_SetCmd2(unsigned char cmd, unsigned char dat1, unsigned char dat2)
{
	LCD_WrCmd(cmd);
	LCD_WrDat(dat1);
	LCD_WrDat(dat2);
}

void LCD_SetCmd3(unsigned char cmd, unsigned char dat1, unsigned char dat2, unsigned char dat3)
{
	LCD_WrCmd(cmd);
	LCD_WrDat(dat1);
	LCD_WrDat(dat2);
	LCD_WrDat(dat3);
}

void LCD_SetCmd4(unsigned char cmd, unsigned char dat1, unsigned char dat2, unsigned char dat3, unsigned char dat4)
{
	LCD_WrCmd(cmd);
	LCD_WrDat(dat1);
	LCD_WrDat(dat2);
	LCD_WrDat(dat3);
	LCD_WrDat(dat4);
}

void LCD_Init(void)
{
	gpio_SetValue(GPIO_CS0, GPIO_VALUE_HIGH);
	gpio_SetValue(GPIO_RESX, GPIO_VALUE_LOW);
	usleep(50000); //  50ms
	gpio_SetValue(GPIO_RESX, GPIO_VALUE_HIGH);
	usleep(50000); //  50ms
	gpio_SetValue(GPIO_DCX, GPIO_VALUE_HIGH);

	/***********WriteSPI*************/
	//P0809-7

	//RTNA
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x11);
	LCD_SetCmd1(0x0A, 0x00);
	LCD_SetCmd1(0x0B, 0x14);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);


	//FRC
	LCD_SetCmd1(0x35, 0x00); //TE ON
	LCD_SetCmd1(0x38, 0x00); //
	LCD_SetCmd1(0x39, 0x1F);

	//RGB
	LCD_SetCmd1(0x3A, 0x02);

	//(1272 x 3 / 24) - 1 
	LCD_SetCmd2(0x2A, 0x00, 0x9E);
	// (1696 *3 ) - 1 
	LCD_SetCmd4(0x2B, 0x00, 0x00, 0x06, 0x9F);

	//Y Res
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x45);
	LCD_SetCmd1(0x00, 0x06);
	LCD_SetCmd1(0x01, 0xA0);

	//Panel Col Addr Set
	//Slave 
	LCD_SetCmd1(0x34, 0x00);
	LCD_SetCmd1(0x35, 0x34);
	//Master
	LCD_SetCmd1(0x32, 0x35);
	LCD_SetCmd1(0x33, 0x69);
	//Slave 
	LCD_SetCmd1(0x36, 0x6A);
	LCD_SetCmd1(0x37, 0x9E);

	//Slave RAM
	LCD_SetCmd1(0x44, 0x03);
	LCD_SetCmd1(0x45, 0x37);
	//Master RAM
	LCD_SetCmd1(0x42, 0x03);
	LCD_SetCmd1(0x43, 0x37);
	//Slave RAM
	LCD_SetCmd1(0x46, 0x03);
	LCD_SetCmd1(0x47, 0x37);

	// dummy = 0
	LCD_SetCmd1(0x07, 0x00);

	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);

	// RAM DISP
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x11);
	LCD_SetCmd1(0x02, 0xB2);
	LCD_SetCmd1(0x1F, 0x10); // 00:column 10:dot
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);

	//GIP
	//STV
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x10);
	LCD_SetCmd1(0x00, 0x01);
	LCD_SetCmd1(0x10, 0x41);
	LCD_SetCmd1(0x11, 0x10);
	LCD_SetCmd1(0x12, 0x00);
	LCD_SetCmd1(0x13, 0x00);
	LCD_SetCmd1(0x15, 0x03);
	LCD_SetCmd1(0x16, 0x10);
	LCD_SetCmd1(0x17, 0x00);
	LCD_SetCmd1(0x18, 0x00);
	LCD_SetCmd1(0x1A, 0x00);
	LCD_SetCmd1(0x1B, 0x00);
	LCD_SetCmd1(0x1C, 0xFF);
	LCD_SetCmd1(0x1D, 0x00);
	//VCK
	LCD_SetCmd1(0x20, 0x01);
	LCD_SetCmd1(0x21, 0x80);
	LCD_SetCmd1(0x22, 0x70);
	LCD_SetCmd1(0x23, 0x00);
	LCD_SetCmd1(0x24, 0x00);
	LCD_SetCmd1(0x25, 0x00);
	LCD_SetCmd1(0x26, 0x12);
	LCD_SetCmd1(0x27, 0x12);
	LCD_SetCmd1(0x28, 0x08);
	LCD_SetCmd1(0x29, 0x08);
	LCD_SetCmd1(0x2A, 0x08);
	LCD_SetCmd1(0x2B, 0x08);
	LCD_SetCmd1(0x2C, 0x00);
	LCD_SetCmd1(0x2D, 0x00);

	LCD_SetCmd1(0x30, 0x00);
	LCD_SetCmd1(0x31, 0x00);
	LCD_SetCmd1(0x32, 0x00);
	LCD_SetCmd1(0x33, 0x00);
	LCD_SetCmd1(0x34, 0x00);
	LCD_SetCmd1(0x35, 0x00);
	LCD_SetCmd1(0x36, 0x00);
	LCD_SetCmd1(0x37, 0x00);
	LCD_SetCmd1(0x38, 0x00);
	LCD_SetCmd1(0x39, 0x00);
	LCD_SetCmd1(0x3A, 0x00);
	LCD_SetCmd1(0x3B, 0x00);
	LCD_SetCmd1(0x3C, 0x00);
	LCD_SetCmd1(0x3D, 0x00);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);

	//GIP MUX
	//GOUT_L FW
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x15);
	LCD_SetCmd1(0x00, 0x00);
	LCD_SetCmd1(0x01, 0x00);
	LCD_SetCmd1(0x02, 0x04);
	LCD_SetCmd1(0x03, 0x14);
	LCD_SetCmd1(0x04, 0x12);
	LCD_SetCmd1(0x05, 0x10);
	LCD_SetCmd1(0x06, 0x0E);
	LCD_SetCmd1(0x07, 0x23);
	LCD_SetCmd1(0x08, 0x22);
	LCD_SetCmd1(0x09, 0x0C);
	LCD_SetCmd1(0x0A, 0x08);
	LCD_SetCmd1(0x0B, 0x24);
	LCD_SetCmd1(0x0C, 0x25);
	LCD_SetCmd1(0x0D, 0x00);
	LCD_SetCmd1(0x0E, 0x00);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);
	//GOUT_R FW
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x16);
	LCD_SetCmd1(0x00, 0x00);
	LCD_SetCmd1(0x01, 0x00);
	LCD_SetCmd1(0x02, 0x05);
	LCD_SetCmd1(0x03, 0x15);
	LCD_SetCmd1(0x04, 0x13);
	LCD_SetCmd1(0x05, 0x11);
	LCD_SetCmd1(0x06, 0x0F);
	LCD_SetCmd1(0x07, 0x23);
	LCD_SetCmd1(0x08, 0x22);
	LCD_SetCmd1(0x09, 0x0C);
	LCD_SetCmd1(0x0A, 0x09);
	LCD_SetCmd1(0x0B, 0x24);
	LCD_SetCmd1(0x0C, 0x25);
	LCD_SetCmd1(0x0D, 0x00);
	LCD_SetCmd1(0x0E, 0x00);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);
	//GOUT_L BW
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x15);
	LCD_SetCmd1(0x20, 0x00);
	LCD_SetCmd1(0x21, 0x00);
	LCD_SetCmd1(0x22, 0x09);
	LCD_SetCmd1(0x23, 0x0F);
	LCD_SetCmd1(0x24, 0x11);
	LCD_SetCmd1(0x25, 0x13);
	LCD_SetCmd1(0x26, 0x15);
	LCD_SetCmd1(0x27, 0x23);
	LCD_SetCmd1(0x28, 0x22);
	LCD_SetCmd1(0x29, 0x0C);
	LCD_SetCmd1(0x2A, 0x05);
	LCD_SetCmd1(0x2B, 0x24);
	LCD_SetCmd1(0x2C, 0x25);
	LCD_SetCmd1(0x2D, 0x00);
	LCD_SetCmd1(0x2E, 0x00);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);
	//GOUT_R FW
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x16);
	LCD_SetCmd1(0x20, 0x00);
	LCD_SetCmd1(0x21, 0x00);
	LCD_SetCmd1(0x22, 0x08);
	LCD_SetCmd1(0x23, 0x0E);
	LCD_SetCmd1(0x24, 0x10);
	LCD_SetCmd1(0x25, 0x12);
	LCD_SetCmd1(0x26, 0x14);
	LCD_SetCmd1(0x27, 0x23);
	LCD_SetCmd1(0x28, 0x22);
	LCD_SetCmd1(0x29, 0x0C);
	LCD_SetCmd1(0x2A, 0x04);
	LCD_SetCmd1(0x2B, 0x24);
	LCD_SetCmd1(0x2C, 0x25);
	LCD_SetCmd1(0x2D, 0x00);
	LCD_SetCmd1(0x2E, 0x00);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);
	//GIP Seq
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x17);
	LCD_SetCmd1(0x37, 0x11);
	LCD_SetCmd1(0x38, 0x20);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);

	//MASTER OFF GIP R
	LCD_SetCmd1(0xF0, 0x01);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x10);
	LCD_SetCmd1(0x00, 0x00);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);
	LCD_SetCmd1(0xF0, 0x02);
	//FW
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x15);
	LCD_SetCmd1(0x00, 0x00);
	LCD_SetCmd1(0x01, 0x00);
	LCD_SetCmd1(0x02, 0x00);
	LCD_SetCmd1(0x03, 0x00);
	LCD_SetCmd1(0x04, 0x00);
	LCD_SetCmd1(0x05, 0x00);
	LCD_SetCmd1(0x06, 0x00);
	LCD_SetCmd1(0x07, 0x00);
	LCD_SetCmd1(0x08, 0x00);
	LCD_SetCmd1(0x09, 0x00);
	LCD_SetCmd1(0x0A, 0x00);
	LCD_SetCmd1(0x0B, 0x00);
	LCD_SetCmd1(0x0C, 0x00);
	LCD_SetCmd1(0x0D, 0x00);
	LCD_SetCmd1(0x0E, 0x00);
	//BW
	LCD_SetCmd1(0x20, 0x00);
	LCD_SetCmd1(0x21, 0x00);
	LCD_SetCmd1(0x22, 0x00);
	LCD_SetCmd1(0x23, 0x00);
	LCD_SetCmd1(0x24, 0x00);
	LCD_SetCmd1(0x25, 0x00);
	LCD_SetCmd1(0x26, 0x00);
	LCD_SetCmd1(0x27, 0x00);
	LCD_SetCmd1(0x28, 0x00);
	LCD_SetCmd1(0x29, 0x00);
	LCD_SetCmd1(0x2A, 0x00);
	LCD_SetCmd1(0x2B, 0x00);
	LCD_SetCmd1(0x2C, 0x00);
	LCD_SetCmd1(0x2D, 0x00);
	LCD_SetCmd1(0x2E, 0x00);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);

	//SLAVE OFF GIP L
	//FW
	LCD_SetCmd1(0xF0, 0x03);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x16);
	LCD_SetCmd1(0x00, 0x00);
	LCD_SetCmd1(0x01, 0x00);
	LCD_SetCmd1(0x02, 0x00);
	LCD_SetCmd1(0x03, 0x00);
	LCD_SetCmd1(0x04, 0x00);
	LCD_SetCmd1(0x05, 0x00);
	LCD_SetCmd1(0x06, 0x00);
	LCD_SetCmd1(0x07, 0x00);
	LCD_SetCmd1(0x08, 0x00);
	LCD_SetCmd1(0x09, 0x00);
	LCD_SetCmd1(0x0A, 0x00);
	LCD_SetCmd1(0x0B, 0x00);
	LCD_SetCmd1(0x0C, 0x00);
	LCD_SetCmd1(0x0D, 0x00);
	LCD_SetCmd1(0x0E, 0x00);
	//BW
	LCD_SetCmd1(0x20, 0x00);
	LCD_SetCmd1(0x21, 0x00);
	LCD_SetCmd1(0x22, 0x00);
	LCD_SetCmd1(0x23, 0x00);
	LCD_SetCmd1(0x24, 0x00);
	LCD_SetCmd1(0x25, 0x00);
	LCD_SetCmd1(0x26, 0x00);
	LCD_SetCmd1(0x27, 0x00);
	LCD_SetCmd1(0x28, 0x00);
	LCD_SetCmd1(0x29, 0x00);
	LCD_SetCmd1(0x2A, 0x00);
	LCD_SetCmd1(0x2B, 0x00);
	LCD_SetCmd1(0x2C, 0x00);
	LCD_SetCmd1(0x2D, 0x00);
	LCD_SetCmd1(0x2E, 0x00);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);


	//ALL GATE OFF
	LCD_SetCmd1(0xF0, 0x00);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x28);
	LCD_SetCmd1(0x00, 0x00);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);


	//VGH/L
	LCD_SetCmd1(0xF0, 0x00);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x12);
	LCD_SetCmd1(0x87, 0xA9);
	//LCD_SetCmd1(0x84, 0x73);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);

	//VCOM
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0xA0);
	LCD_SetCmd1(0x04, 0x25);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);

	//Ram option
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x2D);
	LCD_SetCmd1(0x00, 0x01);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);

	//OTP
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x43);
	LCD_SetCmd1(0x03, 0x04);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);


	//VSH/VSL
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x12);
	LCD_SetCmd1(0x0C, 0x1E);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x12);
	LCD_SetCmd1(0x0D, 0x1E);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);

	//Gate Control
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x28);	
	LCD_SetCmd1(0x00, 0xF9);	
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);	

	//Source Control	
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x18);	
	LCD_SetCmd1(0x00, 0x00);
	LCD_SetCmd1(0x06, 0x51);
	LCD_SetCmd1(0x07, 0x00);	
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);	

	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x41);
	LCD_SetCmd1(0x05, 0x00);
	LCD_SetCmd3(0xFF, 0x21, 0x71, 0x00);

	usleep(50000); //  50ms
	LCD_WrCmd(0x11);

	usleep(120000); //  	120ms
	LCD_WrCmd(0x29);
}

void LCD_Image(unsigned char data[])
{
	int x, y, i, j;
	unsigned char rgb[3] = {0xFF, 0x00, 0x00};
	unsigned char bgr ; 
	unsigned char buf;
	unsigned char date_tmp = 0 ;
	int count = 0;
	LCD_WrCmd(0x2C);
	gpio_SetValue(GPIO_CS0, GPIO_VALUE_LOW);

	for (y = 1696; y >= 0; y--){
		for(x = 0; x < 1272*3; x=x+3){
		date_tmp=data[y * ROW_BYTE_NUM + (x) ];
		data[y * ROW_BYTE_NUM + (x) ]=data[y * ROW_BYTE_NUM + (x)  +2 ];
		data[y * ROW_BYTE_NUM + (x)  +2 ]=date_tmp;
		}
	}
	// transfer to ram buffer
	for (y = 1696; y >= 0; y--){
		for(x = 0; x < 1272*3 / 8; x++){
			buf = 0;
			for (i = 0; i < 8; i++){
				bgr = data[y * ROW_BYTE_NUM + (x) *8 + i ];

				buf |= (bgr >>7) << (i) ;
			
			}
			count++;
            //LCD_WrDat_QSPI(~buf); // R
			LCD_WrDat(~buf);
		}
	}
	//transfer_pixel(&trd[0]);
	
}

int main(int argc, char **argv)
{
	unsigned char i = 0;
	unsigned char rgb[3] = {0x00, 0x00, 0xFF};
	unsigned char *buf;
	int fd;
	FILE *fp;
	unsigned char str[30];
	struct input_event event;

	init_gpio();
	spidev_init();
	LCD_Init();

	fd = open("/dev/input/event1", O_RDWR | O_NONBLOCK);
	if (fd < 0)
    {
        printf("open %s err\n", argv[1]);
        return -1;
    }

	buf = malloc(sizeof(unsigned char) * 1272 * 1696 * 3);
	if (buf == NULL)
	{
		printf("malloc error\n");
		return 0;
	}

	while (!(event.type == EV_KEY && event.value == 1))
	{		
		read(fd, &event, sizeof(event));
		system("python3 bus.py");
		fp = fopen("time.bmp", "rb");
		if (fp == NULL)
		{
			printf("open %s file error\n", str);
			return 0;
		}
		fseek(fp, 54, SEEK_SET);
		fread(buf, sizeof(unsigned char), 1272 * 1696 * 3, fp);
		fclose(fp);
		printf("printing time.bmp...\n");
		LCD_Image(buf);
		usleep(10000000); //  	10s
	}

	free(buf);
	unexport_gpio();
}